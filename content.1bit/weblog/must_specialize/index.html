

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
<meta charset="utf-8">

<META NAME="author" CONTENT="Rodrigo Strauss">
<META NAME="ROBOTS" CONTENT="ALL">
    <title>Forçando a especialização de templates em C++  ::::  Rodrigo Strauss :: www.1bit.com.br</title>
    <link href="../../../1bit.css" type="text/css" rel="stylesheet">
    <link rel="alternate" type="text/xml" title="RSS" href="../../../weblog_rss.1bit">
</head>
  <body style="margin:0px 0px 0px 0px" bgcolor="#FFFFFF">
    <table cellspacing="0" cellpadding="0" width="100%" border="0">
        <tr>
          <td class="header" valign="middle" bgcolor="#ffffff" height="77" colspan="2">&nbsp;
<a href="../../../"><img src="../../../images/logo_novo_2.png" border="0" alt="logo" /></a>

          </td>
        </tr>
        <tr>
          <td class="topmenu"></td>
          <td class="topmenu" align="right" height="30">
		    <a class="top_menu_link" href="content.1bit/contact">Contato</a> 
			<span class="menusep">|</span>
            
            <a class="top_menu_link" href="content.1bit/about">Sobre...</a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
        </tr>
        <tr>
          <td class="topmenu"></td>
          <td>
          <table style="MARGIN: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba1.png" alt="rebarba"></td>
              <td align="right"><img src="../../../images/rebarba2.png" alt="rebarba"></td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td class="menu" valign="top" width="175">

<div class="left_menu_section">
 <h2><a href="../../#artigos" style="text-decoration:none;">Artigos</a></h2>
</div>

<div class="left_menu_section">
 <h2><a href="content.1bit/weblog" style="text-decoration:none;">Blog</a></h2>
</div>

<div class="left_menu_section">
 <h2><a href="content.1bit/opensource" style="text-decoration:none;">Open Source</a></h2>
</div>

<!-- 
<div class="left_menu_section">
 <h2><a href="content.1bit/aulas" style="text-decoration:none;">Aulas online (ou nÃ£o) </a></h2>
</div>
-->


<div id="google_translate_element"></div><script>
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'pt',
    gaTrack: true,
    gaId: 'UA-75310-1',
  }, 'google_translate_element');
}
</script><script src="../..//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<br>

<!-- SiteSearch Google -->
<form method="get" action="http://www.google.com.br/custom" target="_top">
<table border="0" bgcolor="#eeeeee">
<tr><td nowrap="nowrap" valign="top" align="left" height="32">
<a href="http://www.google.com/">
<img src="http://www.google.com/logos/Logo_25wht.gif" border="0" alt="Google" align="middle"></img></a>
<br/>
<input type="hidden" name="domains" value="www.1bit.com.br"></input>
<label for="sbi" style="display: none">Digite os termos da sua pesquisa</label>
<input type="text" name="q" size="23" maxlength="255" value="" id="sbi"></input>
</td></tr>
<tr>
<td nowrap="nowrap">
<table>
<tr>
<td>
<input type="radio" name="sitesearch" value="" id="ss0"></input>
<label for="ss0" title="Pesquisar na web"><font size="-2" color="black">Web</font></label></td>
<td>
<input type="radio" name="sitesearch" value="www.1bit.com.br" checked id="ss1"></input>
<label for="ss1" title="Pesquisar www.1bit.com.br"><font size="-2" color="black">www.1bit.com.br</font></label></td>
</tr>
</table>
<label for="sbb" style="display: none">Enviar formulÃ¡rio de pesquisa</label>
<input type="submit" name="sa" value="Pesquisar" id="sbb"></input>
<input type="hidden" name="client" value="pub-2589539519655496"></input>
<input type="hidden" name="forid" value="1"></input>
<input type="hidden" name="ie" value="ISO-8859-1"></input>
<input type="hidden" name="oe" value="ISO-8859-1"></input>
<input type="hidden" name="cof" value="GALT:#0066CC;GL:1;DIV:#999999;VLC:336633;AH:center;BGC:FFFFFF;LBGC:FFFFFF;ALC:0066CC;LC:0066CC;T:000000;GFNT:666666;GIMP:666666;LH:50;LW:120;L:http://www.1bit.com.br/images/logo_novo_2.png;S:http://;FORID:1"></input>
<input type="hidden" name="hl" value="pt"></input>
</td></tr></table>
</form>
<!-- SiteSearch Google -->
<br>

<br>
<br>
<center>

<br><br><br>

<!--
<a href="http://whos.amung.us/show/xopqoakh"><img src="http://whos.amung.us/cwidget/xopqoakh/fffffff6915a.png" alt="page counter" width="81" height="29" border="0" /></a>
-->

</center>



<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
          </td>
          <td valign="top">
<div class="content">
<h4><a href="content.1bit/weblog" style="text-decoration:none;">Rodrigo Strauss :: Blog</a></h4>
<table border="0">
<tr>
<!-- 
<td width="60">

<a style="text-decoration:none;" href="../../weblog_rss.1bit"><img src="../../../images/xml.gif" border="0"/></a>
</td>
-->

<td>



</td>

<td>




</td>

<td align="right">




<!--

<script type="text/javascript">
google_ad_client = "pub-2589539519655496";
google_ad_width = 468;
google_ad_height = 15;
google_ad_format = "468x15_0ads_al";
google_ad_channel = "";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "FF5000";
google_color_text = "000000";
google_color_url = "FF5000";
</script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
-->






</td>
</tr>
</table>
<br>
<h5>Forçando a especialização de templates em C++</h5><p>Estou refazendo o marshaller de um projeto meu, para que ele use menos macros e fique mais orientado a objetos. Para cada tipo de dado suportado pelo marshaler, deve haver uma classe responsável. E todas as classes devem ser derivadas de um template específico.</p>

<p>(Para quem não sabe o que é um marshaler, vamos lá: o marshaler é o responsável por transportar os parâmetros de uma chamada remota, de um contexto para outro. Quando você usa DCOM e chama um método que está fora do seu processo (rodando em outro EXE ou até em outro computador da rede), o marshaler do DCOM pega os parâmetros da função que você chamou, coloca isso num buffer e manda para o outro contexto. Lá ele lê esse buffer e chama a função do objeto remoto. Para o programador tudo é transparente, já que o DCOM (com uma ajuda das classes de proxy/stub) faz tudo sozinho).</p>

<p>No início, o código ficou assim:</p>

<div class="code">
<pre>
template &lt;typename T&gt;
class CSpTypeMarshaler
{
...
};

template &lt;&gt;
class CSpTypeMarshaler&lt;DWORD&gt;
{
public:
   CSpTypeMarshaler()
   {
      ATLTRACE("especialização para DWORD");
   }
};


template &lt;&gt;
class CSpTypeMarshaler&lt;GUID&gt;
{
public:
   CSpTypeMarshaler()
   {
      ATLTRACE("especialização para GUID");
   }
};

//
// aqui vou declarar os templates
//
CSpTypeMarshaler&lt;DWORD&gt; DwordMarshaler;
CSpTypeMarshaler&lt;GUID&gt; GuidMarshaler;
<b>CSpTypeMarshaler&lt;char&gt; CharMarshaler;</b>
</pre>
</div>

<p>Até aqui tudo bem, nada que a especialização de templates não faça. Mas eu tenho um problema: é possível instanciar o template com qualquer tipo, MESMO QUE NÃO EXISTA ESPECIALIZAÇÃO PARA ELE. Como cada tipo deve ser tratado de uma forma especial, deve existir uma especialização para cada tipo.</p>

<p>Uma possível solução é criar um construtor para o template não especializado. Esse construtor deve gerar um erro de compilação, para que não seja possível instanciar sem especialização. Olhe como ficou agora:</p>


<div class="code">
<pre>
template &lt;typename T&gt;
class CSpTypeMarshaler
{
public:
   CSpTypeMarshaler()
   {
      //
      // isso NÃO FUNCIONA, gera erro sempre
      //
      // #error "Você precisa especializar o template"

      //
      // vamos declarar uma array com limite negativo. 
      // Isso gerará um erro de compilação quando o template
      // for instanciado sem especialização
      //
      char por_favor_especialize_esse_template[-1];

   }
...
};

template &lt;&gt;
class CSpTypeMarshaler&lt;DWORD&gt;
{
public:
   CSpTypeMarshaler()
   {
      ATLTRACE("especialização para DWORD");
   }
};

template &lt;&gt;
class CSpTypeMarshaler&lt;GUID&gt;
{
public:
   CSpTypeMarshaler()
   {
      ATLTRACE("especialização para GUID");
   }
};

//
// aqui vou declarar os templates
//
CSpTypeMarshaler&lt;DWORD&gt; DwordMarshaler;
CSpTypeMarshaler&lt;GUID&gt; GuidMarshaler;
<b>CSpTypeMarshaler&lt;char&gt; CharMarshaler;</b>
</pre>
</div>

<p>Agora, quando eu instanciar o template com o tipo char (que não tem especialização disponível), o compilador acusará o erro:</p>

<div class="code">
<pre>
ConfigManager_ProxyStub.h(48) : error C2118: negative subscript
ConfigManager_ProxyStub.h(46) : 
while compiling class-template member function 
'CSpTypeMarshaler&lt;T&gt;::CSpTypeMarshaler(void)'
    with
    [
        T=char
    ]
</pre>
</div>

<p>Quando o programador desavisado for verificar o motivo do erro, encontrará uma variável <i>por_favor_especialize_esse_template</i>.Quem usa a biblioteca Boost pode usar o <a href="http://www.boost.org/libs/static_assert/static_assert.htm">BOOST_STATIC_ASSERT</a> ao invés de usar esse método da array com tamanho negativo.</p><br><p class="datetime">Em 18/01/2005 04:23, por  Rodrigo Strauss </p>
</div>
          </td>
        </tr>



<tr>
<td class="topmenu"></td>
<td>
<br>
<center>

<script type="text/javascript"><!--
google_ad_client = "pub-2589539519655496";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_type = "text";
google_ad_channel = "";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "FF5000";
google_color_text = "000000";
google_color_url = "FF5000";
google_ui_features = "rc:6";
//-->
</script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</center>
</td>
</tr>

<tr>
 <td class="topmenu"></td>
 <td>
  <table style="margin: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
   <tr>
    <td><img src="../../../images/rebarba3.png"></td>
    <td align="right"><img src="../../../images/rebarba4.png"></td>
   </tr>
  </table>
 </td>
</tr>

<tr><td class="topmenu">&nbsp;</td><td class="topmenu">&nbsp;</td></tr>
<tr><td class="topmenu">&nbsp;</td><td>
<table style="MARGIN: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba1.png"></td>
              <td align="right"><img src="../../../images/rebarba2.png"></td>
              </tr>
            </table>
</td>
</tr>
 <tr><td class="topmenu">&nbsp;</td>
<td>

<div class="content">
<a name="comments"></a><h5>Comentários</h5><div class="post_comment">
<a name="132"></a><B>Wanderley Caloni Jr</B>  | <a rel="nofollow" href="http://www.blakhalk.com.br">website</a> | em 18/01/2005 | <a rel="nofollow" href="../#132">#</a><br>
É uma solução eficaz. Contudo uma outra possibilidade, mais elegante talvez, seria utilizar a conhecida herança de uma classe que tem proteção de construtor:<br><br>class CopyConstructor { CopyConstructor(){} };<br><br>template &lt;typename T&gt;<br>class CSpTypeMarshaler : public CopyConstructor<br>{<br>//...<br>};<br><br>E felizmente esse conceito tb existe no boost, evitando ter que reinventar a roda =).<br><br>[]s
</div>
<div class="post_comment_strauss">
<a name="137"></a><B>Rodrigo Strauss</B>  | <a rel="nofollow" href="http://www.1bit.com.br">website</a> | em 19/01/2005 | <a rel="nofollow" href="../#137">#</a><br>
Por isso que eu adoro C++! Garanto que deve existir mais umas 10 soluções para esse problema...<br><br>Mas assumo que a sua é mais elegante. :-)
</div>
<div class="post_comment_strauss">
<a name="138"></a><B>Rodrigo Strauss</B>  | <a rel="nofollow" href="http://www.1bit.com.br">website</a> | em 19/01/2005 | <a rel="nofollow" href="../#138">#</a><br>
Ah, e seu método tem um probleminha... Se você compilar como warning level 4, o VC dá um warning além do erro:<br><br><i>warning C4610: class 'CSpTypeMarshaler<T>' can never be instantiated - user defined constructor required<br><br>error C2512: 'CSpTypeMarshaler<T>' : no appropriate default constructor available</i><br><br>isso o deixa um pouco menos elegante, só isso :-)
</div>
<div class="post_comment">
<a name="154"></a><B>Fabio Galuppo</B>  | <a rel="nofollow" href="http://br.thespoke.net/MyBlog/fabiog/MyBlog.aspx">website</a> | em 08/02/2005 | <a rel="nofollow" href="../#154">#</a><br>
Mais uma sugestão. <br><br>Crie uma classe/template com o nome desejado no mesmo namespace  com o construtor default (ou outro construtor) como protected ou private. Se desejar, nesta classe adicione os possíveis métodos que será comum nas especializações. O que vc está vendo abaixo é um reforçado na compilação e não em runtime, a propósito isto é uma forma de polimorfismo (através da compilação).<br> <br>template&lt;class T&gt;<br>class MyGenericClass<br>{<br>protected: //ou private:<br>  MyGenericClass(){};<br>public: <br>  void DoSomething(){};<br>};<br><br>template&lt;&gt;<br>class MyGenericClass&lt;char&gt;<br>{<br>public:<br>  MyGenericClass(){ cout &lt;&lt; "Hello from char"; }<br><br>public: <br>  void DoSomething(){ cout &lt;&lt; "Something.."; }<br>};<br><br><br>template&lt;class T&gt;<br>void CallGeneric( MyGenericClass&lt;T&gt;& c )<br>{<br>  c.DoSomething();<br>}<br><br>int main()<br>{<br><br>//MyGenericClass&lt;int&gt; i; //C2248;<br>MyGenericClass&lt;char&gt; c; //fine;<br>c.DoSomething();<br><br>CallGeneric( c );	<br><br>}
</div>
<div class="post_comment">
<a name="168"></a><B>Minha mãe esqueceu de me dar um nome</B>  | em 24/02/2005 | <a rel="nofollow" href="../#168">#</a><br>
Também dá para declarar e não implementar.<br>Vai ter um erro de link caso não tenha sido especializado.<br><br>Eu costumo fazer estes erros de link para contrutores default que não quero usar. Por exemplo:<br><br>class X {<br>  // nao tem implementação para o contrutor default<br>  // caso queria usar este construtor vai dar erro de link<br>  // tb é private para dificultar mais ainda o uso<br>  X(); //nao implementado<br>  int m_i;<br>public:<br>  X(int i) : m_i(i) {}   // quero ter só este construtor<br>};<br>
</div>
<div class="post_comment">
<a name="169"></a><B>Thiago</B>  | <a rel="nofollow" href="http://planeta.terra.com.br/informatica/thiago_adams/">website</a> | em 24/02/2005 | <a rel="nofollow" href="../#169">#</a><br>
Minha mãe me deu um nome mas eu esqueci de colocar no post.<br>:)<br>
</div>
<div class="post_comment">
<a name="2465"></a><B>Andreh Poffo</B>  | em 25/03/2009 | <a rel="nofollow" href="../#2465">#</a><br>
Amigo eu tenho uma dúvida:<br><br>e se por um acaso eu quisesse que a minha especialização forçada fosse de fato uma classe derivada de outra..<br>eu teria que especificar qual seria essa Classe Base.. <br>Dou um exemplo CFiltro (Como ficaria?) :<br><br>--------------------------------------------<br><br>class CFiltro<br>{<br>public: <br>  virtual bool Verify() const = 0;<br>};<br><br>class CFiltroUm : public CFiltro<br>{<br>public:<br>  virtual bool Verify() const<br>  {<br>    return true;<br>  }<br>};<br><br>class CFiltroDois : public CFiltro<br>{<br>public:<br>  virtual bool Verify() const<br>  {<br>    return false;<br>  }<br>};<br><br>template &lt;typename T&gt;<br>class CBufferRegistro<br>{<br>public:<br>   CBufferRegistro()<br>   {<br>      char por_favor_especialize_esse_template[-1];<br>   }<br>};<br><br>template &lt;&gt;<br>class CBufferRegistro&lt;CFiltro*&gt;<br>{<br>public:<br>   bool Verify()<br>   {<br>	return m_Filtro.Verify();<br>   }<br><br>private:<br>   CFiltro* m_Filtro;<br>};<br><br>CBufferRegistro&lt;CFiltroUm&gt; BufferRegistroUm;<br>CBufferRegistro&lt;CFiltroDois&gt; BufferRegistroDois;<br><br>BufferRegistroUm.Verify();	(TRUE)<br>BufferRegistroDois.Verify();	(FALSE)<br><br>--------------------------------------------<br><br>Seria com CFiltro* nos Argumentos para especialização do template mesmo?<br>ou funciona de outro jeito?
</div>



</div>

</td></tr>



















<tr>
          <td class="topmenu"></td>
          <td>
          <table style="margin: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba3.png" alt="rebarba"></td>
              <td align="right"><img src="../../../images/rebarba4.png" alt="rebarba"></td>
            </tr>
          </table>
          </td>
        </tr>

        <tr>
          <td class="topmenu">&nbsp;</td>
          <td class="topmenu" height="25" align="right" style="color:#999999;">
::::
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
        </tr>
    </table>
  </body>
</html>
