

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
<meta charset="utf-8">

<META NAME="author" CONTENT="Rodrigo Strauss">
<META NAME="ROBOTS" CONTENT="ALL">
    <title>Win32: threads  ::::  Rodrigo Strauss :: www.1bit.com.br</title>
    <link href="../../../1bit.css" type="text/css" rel="stylesheet">
    <link rel="alternate" type="text/xml" title="RSS" href="../../../weblog_rss.1bit">
</head>
  <body style="margin:0px 0px 0px 0px" bgcolor="#FFFFFF">
    <table cellspacing="0" cellpadding="0" width="100%" border="0">
        <tr>
          <td class="header" valign="middle" bgcolor="#ffffff" height="77" colspan="2">&nbsp;
<a href="../../../"><img src="../../../images/logo_novo_2.png" border="0" alt="logo" /></a>

          </td>
        </tr>
        <tr>
          <td class="topmenu"></td>
          <td class="topmenu" align="right" height="30">
		    <a class="top_menu_link" href="../../../content.1bit/contact">Contato</a> 
			<span class="menusep">|</span>
            
            <a class="top_menu_link" href="../../../content.1bit/about">Sobre...</a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
        </tr>
        <tr>
          <td class="topmenu"></td>
          <td>
          <table style="MARGIN: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba1.png" alt="rebarba"></td>
              <td align="right"><img src="../../../images/rebarba2.png" alt="rebarba"></td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td class="menu" valign="top" width="175">

<div class="left_menu_section">
 <h2><a href="../../../#artigos" style="text-decoration:none;">Artigos</a></h2>
</div>

<div class="left_menu_section">
 <h2><a href="../../../content.1bit/weblog_archive" style="text-decoration:none;">Blog</a></h2>
</div>

<div class="left_menu_section">
 <h2><a href="../../../content.1bit/opensource" style="text-decoration:none;">Open Source</a></h2>
</div>

<!-- 
<div class="left_menu_section">
 <h2><a href="content.1bit/aulas" style="text-decoration:none;">Aulas online (ou não) </a></h2>
</div>
-->


<br>
<br>
<br>
<center>

<!--
<a href="http://whos.amung.us/show/xopqoakh"><img src="http://whos.amung.us/cwidget/xopqoakh/fffffff6915a.png" alt="page counter" width="81" height="29" border="0" /></a>
-->

</center>



<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
          </td>
          <td valign="top">
<div class="content">
<h4><a href="../../../content.1bit/weblog_archive" style="text-decoration:none;">Rodrigo Strauss :: Blog</a></h4>
<table border="0">
<tr>
<!-- 
<td width="60">

<a style="text-decoration:none;" href="../../weblog_rss.1bit"><img src="../../../images/xml.gif" border="0"/></a>
</td>
-->

<td>



</td>

<td>




</td>

<td align="right">




<!--

<script type="text/javascript">
google_ad_client = "pub-2589539519655496";
google_ad_width = 468;
google_ad_height = 15;
google_ad_format = "468x15_0ads_al";
google_ad_channel = "";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "FF5000";
google_color_text = "000000";
google_color_url = "FF5000";
</script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
-->






</td>
</tr>
</table>
<br>
<h5>Win32: threads</h5><p>Uma thread é basicamente uma linha de execução independente, contida dentro de um processo. Ou seja, uma thread permite que um processo "faça varias coisas de forma simultânea", já que um processo pode conter várias threads. Todas as threads que fazem parte de um mesmo processo compartilham vários recursos, como o espaçamento de memória e os handles. Ou seja, elas acessam as mesmas variávies e podem usar os mesmos handles ao mesmo tempo.</p>

<p>Quando um processo é criado no Windows, é criado junto com ele a thread principal, que é thread que roda a função main ou WinMain. A partir daí é possível criar novas threads, como no exemplo abaixo:</p>

<div class="code">
<pre><span class="keyword">#include</span> <span class="literal">"stdafx.h"</span><span class="keyword">
#include</span> &lt;windows.h><span class="keyword">
#include</span> &lt;iostream>
&nbsp;
&nbsp;
<span class="keyword">using</span> <span class="keyword">namespace</span> std;

&nbsp;
<span class="comment">//
</span><span class="comment">// WINAPI é um #define para __stdcall
</span><span class="comment">//
</span>DWORD WINAPI ThreadProc(<span class="keyword">void</span>* lpv)
{
  <span class="comment">//
</span>  <span class="comment">// vamos esperar até 500 ms com o nosso random() de pobre
</span>  <span class="comment">//
</span>  Sleep(GetTickCount() % 500);
  <span class="keyword">return</span> 0;
}
&nbsp;
<span class="keyword">int</span> main()
{
  DWORD dwThreadID;
  <span class="keyword">static</span> <span class="keyword">const</span> DWORD THREAD_COUNT = 20;
  HANDLE hThreads[THREAD_COUNT];
&nbsp;
  <span class="comment">//
</span>  <span class="comment">// vamos criar nossas threads
</span>  <span class="comment">//
</span>  <span class="keyword">for</span>(DWORD a = 0 ; a &lt; THREAD_COUNT ; a++)
  {
    hThreads[a] = 
      CreateThread(NULL, <span class="comment">// segurança, vamos deixar o default
</span>      NULL,        <span class="comment">// tamanho da pilha. O default é 1MB
</span>      &amp;ThreadProc,     <span class="comment">// função da thread
</span>      NULL,        <span class="comment">// parâmetro da thread
</span>      NULL,        <span class="comment">// flag de criação. Podemos usá-lo para criar um thread suspensa
</span>      &amp;dwThreadID);
&nbsp;
    <span class="comment">//
</span>    <span class="comment">// O Sleep(0) diz ao scheduler do Windows que ele
</span>    <span class="comment">// pode agendar a próxima thread em espera, e nós
</span>    <span class="comment">// vamos para o fim da fila. 
</span>    <span class="comment">//
</span>    Sleep(0);
  }
&nbsp;
  <span class="comment">//
</span>  <span class="comment">// coloque um breakpoint aqui, vá no menu Debug >> Windows >> Threads
</span>  <span class="comment">// e veja as threads que criamos na lista
</span>  <span class="comment">//
</span>  __asm nop; <span class="comment">// instrução x86 que não faz absolutamente nada
</span>&nbsp;
  <span class="comment">//
</span>  <span class="comment">// Para esperar uma thread parar (o que os linux boys conhecem como 'join')
</span>  <span class="comment">// usamos WaitForSingleObject ou WaitForMultipleObjects. Essas funções
</span>  <span class="comment">// funcionam com handles de processos, threads, mutexes e outras coisas mais
</span>  <span class="comment">// que veremos depois
</span>  <span class="comment">//
</span>  DWORD dw = WaitForSingleObject(
    hThreads[0], <span class="comment">// handle
</span>    100); <span class="comment">// vamos esperar 100 ms
</span>&nbsp;
  <span class="keyword">if</span>(dw == WAIT_TIMEOUT)
  {
    <span class="comment">//
</span>    <span class="comment">// não retornou em 100ms... Vamos esperar para sempre
</span>    <span class="comment">//
</span>    dw = WaitForSingleObject(hThreads[0], INFINITE);
  }
  <span class="keyword">else</span> <span class="keyword">if</span>(dw == WAIT_OBJECT_0)
  {
    <span class="comment">//
</span>    <span class="comment">// esperamos menos de 100 ms
</span>    <span class="comment">//
</span>  }
&nbsp;
  <span class="comment">//
</span>  <span class="comment">// agora vamos ver qual thread para primeiro
</span>  <span class="comment">//
</span>&nbsp;
  dw = WaitForMultipleObjects(
    THREAD_COUNT - 1, <span class="comment">// quantos handles na array
</span>    hThreads + 1,     <span class="comment">// array de threads + 1, porque a thread 0 já acabou
</span>    FALSE,            <span class="comment">// não quero esperar por todas, se algum thread acabar está bom
</span>    INFINITE);        <span class="comment">// senta e espera
</span>&nbsp;
  DWORD qualThread = dw - WAIT_OBJECT_0;
&nbsp;
  cout &lt;&lt; <span class="literal">"a thread mais rápida foi a "</span> &lt;&lt; qualThread &lt;&lt; endl;
&nbsp;
  <span class="comment">//
</span>  <span class="comment">// agora vamos esperar todas de uma vez --------------|
</span>  <span class="comment">//                                                    v
</span>  dw = WaitForMultipleObjects(THREAD_COUNT, hThreads, TRUE, INFINITE);
&nbsp;
  <span class="comment">//
</span>  <span class="comment">// Como a API é C, vamos fechar os handles. Lembrando que
</span>  <span class="comment">// o Windows faz isso automaticamente quando o processo acaba
</span>  <span class="comment">//
</span>  <span class="keyword">for</span>(DWORD a = 0 ; a &lt; THREAD_COUNT ; a++)
    CloseHandle(hThreads[a]);
&nbsp;
  <span class="keyword">return</span> 0;
}</pre>
</div>

<p>A única diferença entre as threads criadas posteriormente e a thread principal de um processo é que quando a thread principal acaba, todas as outras threads são forçosamente terminadas e o processo acaba - caso contrário uma thread esquecida poderia deixar o processo em um estado de limbo. Em um computador rodando Windows, em uma determinada hora, temos várias threads rodando, e a thread é única entidade que faz uso do processador. No Windows, um processo não "roda" nem é executado. O que "roda" é uma thread (que por sua vez pertence à um processo). Dessa forma, o scheduler (agendador) do Windows trabalha compartilhando e dividindo o uso do processador entre as threads do sistema, independente do processo que contém a thread.</p>

<p>Em uma de suas atuações, o scheduler do Windows (e de qualquer SO) funciona basicamente respondendo à uma interrupção de timer que acontece em intervalos de milissegundos. Quando essa interrupção ocorre, a thread atual é interrompida, e o scheduler toma seu lugar no processador para verificar se é necessário trocar de thread. Caso o quantum (tempo de cpu determinado para que a thread rode antes de outra thread assumir o processador) da thread atual tenha terminado, o scheduler salva os registradores que definem o estado atual da thread no thread context (veja a estrutura _CONTEXT no winnt.h) e carrega os registradores da próxima thread a ser executada. Com a nova thread pronta para utilizar o processador, o scheduler coloca a thread atual no fim da fila. Falando em código, o ponteiro da estrutura ETHREAD que representa a thread é colocada no fim de uma lista duplamente ligada que controla a fila de threads em estado ready.</p>

<p>Quando só existe um processador ou core no computador, o scheduler dá a impressão de que as threads estão sendo executadas simultaneamente, alternando entre elas dessa forma. Quando mais de um processador ou core estão disponíves, várias threads podem ser executadas simultaneamente, o que faz com que o scheduler precise distribuir as threads entre os N processadores disponíveis.</p>

<p>O tempo de interrupção citado é de 20 à 120ms, dependendo do processador e da versão do Windows. Nas versões Home, Professional e Business, os intervalos são de 20ms, para que o sistema seja mais responsivo ao usuário interativo. O intervalo de 120ms é usado nas versões Server, pois quanto maior o quantum, maior a probabilidade da thread conseguir atender a requisição em um quantum só, aumentando a vazão do servidor.</p>

<p>Outra situação onde o scheduler aparece é quando uma thread deve esperar uma operação de I/O. Nesse caso a thread perde o controle do processador antes que seu quantum acabe, e ela só será colocada novamente na lista de threads ready (prontas para serem executadas) quando essa requisição de I/O for respondida.</p>

<p>Como sempre, mais informações podem ser encontradas na MSDN (sobre as funções CreateThread e WaitForXXX), Wikipedia (sobre conceitos do sistemas operacionais, como quantum e thread) e no livro "Windows Internals" (sobre a implementação dos conceitos no kernel do Windows).</p><br><p class="datetime">Em 15/04/2008 20:46, por  Rodrigo Strauss </p>
</div>
          </td>
        </tr>



<tr>
<td class="topmenu"></td>
<td>
<br>
<center>

<script type="text/javascript"><!--
google_ad_client = "pub-2589539519655496";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_type = "text";
google_ad_channel = "";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "FF5000";
google_color_text = "000000";
google_color_url = "FF5000";
google_ui_features = "rc:6";
//-->
</script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</center>
</td>
</tr>

<tr>
 <td class="topmenu"></td>
 <td>
  <table style="margin: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
   <tr>
    <td><img src="../../../images/rebarba3.png"></td>
    <td align="right"><img src="../../../images/rebarba4.png"></td>
   </tr>
  </table>
 </td>
</tr>

<tr><td class="topmenu">&nbsp;</td><td class="topmenu">&nbsp;</td></tr>
<tr><td class="topmenu">&nbsp;</td><td>
<table style="MARGIN: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba1.png"></td>
              <td align="right"><img src="../../../images/rebarba2.png"></td>
              </tr>
            </table>
</td>
</tr>
 <tr><td class="topmenu">&nbsp;</td>
<td>

<div class="content">
<a name="comments"></a><h5>Comentários</h5><div class="post_comment">
<a name="2254"></a><B>LVR</B>  | em 17/04/2008 | <a rel="nofollow" href="../#2254">#</a><br>
Reclamei no outro post, sobre a questão Processo x Thread, pois sou um chato advindo dos Unices. Mas, gostei da explanação. O primeiro paragráfo é suficientemente esclarecedor, mesmo para quem nunca tenha ouvido nada respeito.<br><br>[]´s<br><br>---<br>LVR<br>
</div>
<div class="post_comment">
<a name="2350"></a><B>MSP</B>  | em 19/08/2008 | <a rel="nofollow" href="../#2350">#</a><br>
É... concordo. O primeiro parágrafo esclarece bem o que é thread, principalmente se considerarmos as traduções brasileirindias dos livros importados.<br><br>Abraço<br><br>MSP
</div>
<div class="post_comment">
<a name="2481"></a><B>Negrão</B>  | em 19/05/2009 | <a rel="nofollow" href="../#2481">#</a><br>
Gostei da explicação, mas com certeza vc não tirou isso da sua cabeça. Gostaria de saber a fonte das informções.<br>Um abraço.
</div>
<div class="post_comment_strauss">
<a name="2484"></a><B>Rodrigo Strauss</B>  | <a rel="nofollow" href="http://www.1bit.com.br">website</a> | em 20/05/2009 | <a rel="nofollow" href="../#2484">#</a><br>
 <a rel="nofollow" href="http://msdn.microsoft.com/">http://msdn.microsoft.com/</a><br>Livros "Windows Internals", "Programming Windows 95" e "Advanced Windows".<br>Windows Platform SDK
</div>



</div>

</td></tr>



















<tr>
          <td class="topmenu"></td>
          <td>
          <table style="margin: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba3.png" alt="rebarba"></td>
              <td align="right"><img src="../../../images/rebarba4.png" alt="rebarba"></td>
            </tr>
          </table>
          </td>
        </tr>

        <tr>
          <td class="topmenu">&nbsp;</td>
          <td class="topmenu" height="25" align="right" style="color:#999999;">
::::
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
        </tr>
    </table>
  </body>
</html>
