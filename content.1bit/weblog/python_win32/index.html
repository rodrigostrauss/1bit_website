

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
  <head>
<meta charset="utf-8">

<META NAME="author" CONTENT="Rodrigo Strauss">
<META NAME="ROBOTS" CONTENT="ALL">
    <title>Acessando a API Win32 usando Python  ::::  Rodrigo Strauss :: www.1bit.com.br</title>
    <link href="../../../1bit.css" type="text/css" rel="stylesheet">
    <link rel="alternate" type="text/xml" title="RSS" href="../../../weblog_rss.1bit">
</head>
  <body style="margin:0px 0px 0px 0px" bgcolor="#FFFFFF">
    <table cellspacing="0" cellpadding="0" width="100%" border="0">
        <tr>
          <td class="header" valign="middle" bgcolor="#ffffff" height="77" colspan="2">&nbsp;
<a href="../../../"><img src="../../../images/logo_novo_2.png" border="0" alt="logo" /></a>

          </td>
        </tr>
        <tr>
          <td class="topmenu"></td>
          <td class="topmenu" align="right" height="30">
		    <a class="top_menu_link" href="../../../content.1bit/contact">Contato</a> 
			<span class="menusep">|</span>
            
            <a class="top_menu_link" href="../../../content.1bit/about">Sobre...</a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
        </tr>
        <tr>
          <td class="topmenu"></td>
          <td>
          <table style="MARGIN: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba1.png" alt="rebarba"></td>
              <td align="right"><img src="../../../images/rebarba2.png" alt="rebarba"></td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <td class="menu" valign="top" width="175">

<div class="left_menu_section">
 <h2><a href="../../../#artigos" style="text-decoration:none;">Artigos</a></h2>
</div>

<div class="left_menu_section">
 <h2><a href="../../../content.1bit/weblog_archive" style="text-decoration:none;">Blog</a></h2>
</div>

<div class="left_menu_section">
 <h2><a href="../../../content.1bit/opensource" style="text-decoration:none;">Open Source</a></h2>
</div>

<!-- 
<div class="left_menu_section">
 <h2><a href="content.1bit/aulas" style="text-decoration:none;">Aulas online (ou não) </a></h2>
</div>
-->


<br>
<br>
<br>
<center>

<!--
<a href="http://whos.amung.us/show/xopqoakh"><img src="http://whos.amung.us/cwidget/xopqoakh/fffffff6915a.png" alt="page counter" width="81" height="29" border="0" /></a>
-->

</center>



<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
          </td>
          <td valign="top">
<div class="content">
<h4><a href="../../../content.1bit/weblog_archive" style="text-decoration:none;">Rodrigo Strauss :: Blog</a></h4>
<table border="0">
<tr>
<!-- 
<td width="60">

<a style="text-decoration:none;" href="../../weblog_rss.1bit"><img src="../../../images/xml.gif" border="0"/></a>
</td>
-->

<td>



</td>

<td>




</td>

<td align="right">




<!--

<script type="text/javascript">
google_ad_client = "pub-2589539519655496";
google_ad_width = 468;
google_ad_height = 15;
google_ad_format = "468x15_0ads_al";
google_ad_channel = "";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "FF5000";
google_color_text = "000000";
google_color_url = "FF5000";
</script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
-->






</td>
</tr>
</table>
<br>
<h5>Acessando a API Win32 usando Python</h5><p>Como muitos devem saber, eu voltei a trabalhar com drivers. Meu projeto específico aqui na Axur é o <a href="http://www.axur.com.br/?session=113&sub=1&prod=9">AMS</a>, um software que (simplificadamente) monitora o acesso à file servers. Durante a caçada à um bug eu precisei fazer um programa de testes para reproduzir um cenário descrito no nosso controle de bugs. Nesse cenário, eu precisa acessar certos arquivos com flags específicas da função CreateFile da API Win32.</p>

<p>Fácil. É só abrir o Visual C++ e escrever algumas linhas. Mas Python é mais indicado para programinhas pequenos de teste (não preciso de performance e o fato do código fonte ser aberto não é um problema). Então decidi fazer em Python, e vou mostrar aqui as duas opções que eu conheço para isso.</p>

<p>A primeira delas é usar o <a href="http://docs.python.org/lib/module-ctypes.html">ctypes</a>, que vem na distribuição padrão do Python 2.5. "Batteries included", lembra? Essa biblioteca provê um acesso MUITO fácil à código C (DLLs, APIs, etc) usando Python. Sinceramente, nunca vi nada tão fácil e prático, nem em VB ou C#. O código fica simples assim:</p>

<div class="code">
<pre>&gt;&gt;&gt; <span class="keyword">import</span> ctypes
&gt;&gt;&gt; CreateFile = ctypes.windll.kernel32.CreateFile
Traceback (most recent call last):
  File <span class="literal">"&lt;interactive input&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;
  File <span class="literal">"C:\Python25\lib\ctypes\__init__.py"</span>, line 353, <span class="keyword">in</span> __getattr__
    func = self.__getitem__(name)
  File <span class="literal">"C:\Python25\lib\ctypes\__init__.py"</span>, line 358, <span class="keyword">in</span> __getitem__
    func = self._FuncPtr((name_or_ordinal, self))
AttributeError: function <span class="literal">'CreateFile'</span> <span class="keyword">not</span> found

&gt;&gt;&gt; <span class="comment"># ooops. Lembra das funções ANSI e UNICODE? Já falei detalhadamente sobre isso
</span>&gt;&gt;&gt; <span class="comment"># nos <a href="../../../content.1bit/windbg2">tutoriais de WinDbg</a> (que pretendo retomar agora que voltei a fazer drivers)
</span>&gt;&gt;&gt; <a href="http://msdn2.microsoft.com/en-us/library/aa363858.aspx">CreateFile</a> = ctypes.windll.kernel32.CreateFileA
&gt;&gt;&gt; CreateFile
&lt;_FuncPtr object at 0x012DF288&gt;
&gt;&gt;&gt;</pre></div>

<p>Simples assim. A variável <i>CreateFile</i> já é um ponteiro para a função CreateFile da API. Como exemplo vamos ler o arquivo boot.ini:</p>

<div class="code">
<pre>
&gt;&gt;&gt;<span class="comment"> # ** CONTINUAÇÃO**</span>
&gt;&gt;&gt;<span class="comment"> # uma ajudinha. Copiei isso do winnt.h. Como são defines, 
</span>&gt;&gt;&gt; <span class="comment"># não dá pra "importar" como as funções
</span>&gt;&gt;&gt; GENERIC_READ = 0x80000000
&gt;&gt;&gt; GENERIC_WRITE = 0x40000000
&gt;&gt;&gt; FILE_SHARE_READ = 0x00000001
&gt;&gt;&gt; OPEN_EXISTING = 3
&gt;&gt;&gt; h = CreateFile(r<span class="literal">'c:\boot.ini'</span>, GENERIC_READ, FILE_SHARE_READ,
     None, OPEN_EXISTING, None, None)
&gt;&gt;&gt; <span class="comment"># se for erro, retorna INVALID_HANDLE_VALUE, que é 0xFFFFFFFF
</span>&gt;&gt;&gt; h
532
&gt;&gt;&gt; <span class="comment"># tudo ok. vamos ler
</span>&gt;&gt;&gt; <a href="http://msdn2.microsoft.com/en-us/library/Aa365467.aspx">ReadFile</a> = ctypes.windll.kernel32.ReadFile
&gt;&gt;&gt; <span class="comment"># preciso de um buffer para ler o arquivo.
</span>&gt;&gt;&gt; buffer = ctypes.create_string_buffer(4096)
&gt;&gt;&gt; buffer
&lt;ctypes.c_char_Array_4096 object at 0x012DDE40&gt;
&gt;&gt;&gt; <span class="comment">#preciso também passar o ponteiro de um LONG (int) para saber o quanto foi lido
</span>&gt;&gt;&gt; BytesRead = ctypes.c_long()
&gt;&gt;&gt; BytesRead
c_long(0)
&gt;&gt;&gt; ret = ReadFile(h, buffer, len(buffer), ctypes.byref(BytesRead), None)
&gt;&gt;&gt; ret
1
&gt;&gt;&gt; <span class="comment"># funcionou
</span>&gt;&gt;&gt; <span class="keyword">print</span> buffer.value
[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(1)\WINDOWS
[operating systems]
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Microsoft Windows XP Professional" 
/noexecute=optin /fastdetect
&nbsp;
&gt;&gt;&gt; <span class="comment">#bytes lidos:
</span>&gt;&gt;&gt; <span class="keyword">print</span> BytesRead.value
211
&gt;&gt;&gt; <span class="comment"># Não preciso pegar o ponteiro de função em uma variável,
</span>&gt;&gt;&gt; <span class="comment"># posso chamar diretamente
</span>&gt;&gt;&gt; ctypes.windll.kernel32.CloseHandle(h)
1
&gt;&gt;&gt;
</pre></div>

<p>A segunda opção é usar o pacote <a href="http://sourceforge.net/projects/pywin32/">PyWin32</a>, que é um wrapper para a API Win32 feito em Python. Ele encpasula praticamente toda a API Win32, toda a runtime COM e a MFC. Esse pacote vem com uma IDE para Python muito boa, chamada PythonWin. Ela é feita em Python usando MFC.</p>

<p>Talk is cheap, show me the code:</p>

<div class="code">
<pre>
&gt;&gt;&gt; <span class="keyword">import</span> win32file
&gt;&gt;&gt; h = win32file.CreateFile(r<span class="literal">'c:\boot.ini'</span>, win32file.GENERIC_READ, 
win32file.FILE_SHARE_READ, None, win32file.OPEN_EXISTING, 0, 0)
&gt;&gt;&gt; h
&lt;PyHANDLE:504&gt;
&gt;&gt;&gt; err, str = win32file.ReadFile(h, 1024)
&gt;&gt;&gt; err
0

&gt;&gt;&gt; <span class="keyword">print</span> str
[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(1)\WINDOWS
[operating systems]
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=<span class="literal">"Microsoft Windows XP Professional"</span> 
/noexecute=optin /fastdetect
&gt;&gt;&gt; <span class="comment">Não precisamos fechar o handle, o tipo PyHANDLE cuida disso</span>
&gt;&gt;&gt; <span class="comment">Use "del h" se quiser fechar na hora</span>
</pre></div>

<p>Algumas coisas são mais fáceis usando PyWin32, mas temos também algumas desvantagens. As assinaturas das funções não são exatamente as mesmas da API e esse pacote vem separado da distribuição padrão do Python.</p><br><p class="datetime">Em 20/10/2007 23:56, por  Rodrigo Strauss </p>
</div>
          </td>
        </tr>



<tr>
<td class="topmenu"></td>
<td>
<br>
<center>

<script type="text/javascript"><!--
google_ad_client = "pub-2589539519655496";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_type = "text";
google_ad_channel = "";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "FF5000";
google_color_text = "000000";
google_color_url = "FF5000";
google_ui_features = "rc:6";
//-->
</script>
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</center>
</td>
</tr>

<tr>
 <td class="topmenu"></td>
 <td>
  <table style="margin: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
   <tr>
    <td><img src="../../../images/rebarba3.png"></td>
    <td align="right"><img src="../../../images/rebarba4.png"></td>
   </tr>
  </table>
 </td>
</tr>

<tr><td class="topmenu">&nbsp;</td><td class="topmenu">&nbsp;</td></tr>
<tr><td class="topmenu">&nbsp;</td><td>
<table style="MARGIN: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba1.png"></td>
              <td align="right"><img src="../../../images/rebarba2.png"></td>
              </tr>
            </table>
</td>
</tr>
 <tr><td class="topmenu">&nbsp;</td>
<td>

<div class="content">
<a name="comments"></a><h5>Comentários</h5><div class="post_comment">
<a name="2071"></a><B>Thyago</B>  | em 20/10/2007 | <a rel="nofollow" href="../#2071">#</a><br>
Poderia também usar um intepretador de C/C++,  <a rel="nofollow" href="http://www.ddj.com/cpp/184402054">http://www.ddj.com/cpp/184402054</a><br><br>Existem outros alem do ch...
</div>



</div>

</td></tr>



















<tr>
          <td class="topmenu"></td>
          <td>
          <table style="margin: 0px" cellspacing="0" cellpadding="0" width="100%" border="0">
            <tr>
              <td><img src="../../../images/rebarba3.png" alt="rebarba"></td>
              <td align="right"><img src="../../../images/rebarba4.png" alt="rebarba"></td>
            </tr>
          </table>
          </td>
        </tr>

        <tr>
          <td class="topmenu">&nbsp;</td>
          <td class="topmenu" height="25" align="right" style="color:#999999;">
::::
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </td>
        </tr>
    </table>
  </body>
</html>
